<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ì„¤ì¹˜ ì§„ë‹¨ ë„êµ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
        }
        .check-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .check-item.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .check-item.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .check-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .status {
            font-weight: bold;
            margin-right: 10px;
        }
        .success .status { color: #10b981; }
        .error .status { color: #ef4444; }
        .warning .status { color: #f59e0b; }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .install-button {
            background: #10b981;
        }
        .install-button:hover {
            background: #059669;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .section {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ PWA ì„¤ì¹˜ ì§„ë‹¨ ë„êµ¬</h1>
        
        <div class="section">
            <h2>1. ê¸°ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
            <div id="checks"></div>
        </div>

        <div class="section">
            <h2>2. ì„¤ì¹˜ ìƒíƒœ</h2>
            <div id="install-status"></div>
            <button id="install-btn" class="install-button" style="display:none;">
                ğŸ“± ì•± ì„¤ì¹˜í•˜ê¸°
            </button>
            <button id="clear-cache-btn">
                ğŸ—‘ï¸ ìºì‹œ ì´ˆê¸°í™”
            </button>
        </div>

        <div class="section">
            <h2>3. ë¦¬ì†ŒìŠ¤ ì²´í¬</h2>
            <button id="check-resources-btn">
                ğŸ” ë¦¬ì†ŒìŠ¤ ê²€ì‚¬ ì‹œì‘
            </button>
            <div id="resources"></div>
        </div>

        <div class="section">
            <h2>4. ë””ë²„ê·¸ ë¡œê·¸</h2>
            <pre id="debug-log"></pre>
        </div>
    </div>

    <script>
        const log = [];
        let deferredPrompt = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            log.push(logEntry);
            document.getElementById('debug-log').textContent = log.join('\n');
            console.log(logEntry);
        }

        function addCheck(id, label, status, message) {
            const checksDiv = document.getElementById('checks');
            const checkDiv = document.createElement('div');
            checkDiv.className = `check-item ${status}`;
            checkDiv.innerHTML = `
                <span class="status">${status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸'}</span>
                <strong>${label}:</strong> ${message}
            `;
            checksDiv.appendChild(checkDiv);
        }

        // 1. HTTPS ì²´í¬
        function checkHTTPS() {
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (isHTTPS || isLocalhost) {
                addCheck('https', 'HTTPS/Localhost', 'success', 
                    isHTTPS ? 'HTTPSë¡œ ì ‘ì† ì¤‘' : 'Localhostì—ì„œ ì‹¤í–‰ ì¤‘');
                addLog('HTTPS check passed');
                return true;
            } else {
                addCheck('https', 'HTTPS', 'error', 
                    'PWAëŠ” HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤');
                addLog('HTTPS check failed', 'error');
                return false;
            }
        }

        // 2. Service Worker ì²´í¬
        async function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length > 0) {
                        addCheck('sw', 'Service Worker', 'success', 
                            `${registrations.length}ê°œì˜ Service Workerê°€ ë“±ë¡ë¨`);
                        addLog(`Found ${registrations.length} service worker(s)`);
                        
                        // Service Worker ìƒíƒœ í™•ì¸
                        registrations.forEach((reg, index) => {
                            addLog(`SW ${index}: ${reg.scope}, Active: ${reg.active ? 'Yes' : 'No'}`);
                        });
                        return true;
                    } else {
                        addCheck('sw', 'Service Worker', 'warning', 
                            'Service Workerê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ');
                        addLog('No service worker registered', 'warning');
                        return false;
                    }
                } catch (error) {
                    addCheck('sw', 'Service Worker', 'error', 
                        `ì˜¤ë¥˜: ${error.message}`);
                    addLog(`Service Worker error: ${error.message}`, 'error');
                    return false;
                }
            } else {
                addCheck('sw', 'Service Worker', 'error', 
                    'ë¸Œë¼ìš°ì €ê°€ Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ');
                addLog('Service Worker not supported', 'error');
                return false;
            }
        }

        // 3. Manifest ì²´í¬
        async function checkManifest() {
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                try {
                    const response = await fetch(manifestLink.href);
                    if (response.ok) {
                        const manifest = await response.json();
                        addCheck('manifest', 'Manifest', 'success', 
                            `manifest.json ë¡œë“œ ì„±ê³µ (${manifest.name})`);
                        addLog(`Manifest loaded: ${manifest.name}`);
                        
                        // í•„ìˆ˜ í•„ë“œ í™•ì¸
                        const required = ['name', 'short_name', 'icons', 'start_url', 'display'];
                        const missing = required.filter(field => !manifest[field]);
                        
                        if (missing.length > 0) {
                            addLog(`Missing manifest fields: ${missing.join(', ')}`, 'warning');
                        }
                        
                        return true;
                    } else {
                        addCheck('manifest', 'Manifest', 'error', 
                            `manifest.json ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
                        addLog(`Manifest load failed: ${response.status}`, 'error');
                        return false;
                    }
                } catch (error) {
                    addCheck('manifest', 'Manifest', 'error', 
                        `ì˜¤ë¥˜: ${error.message}`);
                    addLog(`Manifest error: ${error.message}`, 'error');
                    return false;
                }
            } else {
                addCheck('manifest', 'Manifest', 'error', 
                    'manifest ë§í¬ê°€ ì—†ìŒ');
                addLog('No manifest link found', 'error');
                return false;
            }
        }

        // 4. ì„¤ì¹˜ ìƒíƒœ ì²´í¬
        function checkInstallStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                || window.navigator.standalone 
                || document.referrer.includes('android-app://');
            
            const statusDiv = document.getElementById('install-status');
            
            if (isStandalone) {
                statusDiv.innerHTML = '<div class="check-item success"><strong>âœ… ì•±ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤</strong></div>';
                addLog('App is already installed');
            } else {
                statusDiv.innerHTML = '<div class="check-item warning"><strong>âš ï¸ ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ (ë¸Œë¼ìš°ì € ëª¨ë“œ)</strong></div>';
                addLog('App not installed (browser mode)');
            }
            
            return isStandalone;
        }

        // 5. ë¦¬ì†ŒìŠ¤ ì²´í¬
        async function checkResources() {
            const resourcesDiv = document.getElementById('resources');
            resourcesDiv.innerHTML = '<p>ê²€ì‚¬ ì¤‘...</p>';
            
            const iconSizes = ['16x16', '32x32', '72x72', '96x96', '128x128', 
                              '144x144', '152x152', '192x192', '384x384', '512x512'];
            
            const results = [];
            let errorCount = 0;
            
            // ë°ì€ í…Œë§ˆ ì•„ì´ì½˜ ì²´í¬
            for (const size of iconSizes) {
                const urls = [
                    `/icons/coms_b-${size}.png`,
                    `/icons/coms-d-${size}.png`,  // ë‹¤í¬ ëª¨ë“œ (í•˜ì´í”ˆ)
                    `/icons/coms_d-${size}.png`    // ë‹¤í¬ ëª¨ë“œ (ì–¸ë”ìŠ¤ì½”ì–´)
                ];
                
                for (const url of urls) {
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        if (response.ok) {
                            results.push(`âœ… ${url}`);
                            addLog(`Resource OK: ${url}`);
                        } else {
                            results.push(`âŒ ${url} (${response.status})`);
                            addLog(`Resource failed: ${url} (${response.status})`, 'error');
                            errorCount++;
                        }
                    } catch (error) {
                        results.push(`âŒ ${url} (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)`);
                        addLog(`Resource error: ${url}`, 'error');
                        errorCount++;
                    }
                }
            }
            
            resourcesDiv.innerHTML = `
                <div class="check-item ${errorCount === 0 ? 'success' : 'error'}">
                    <strong>ì•„ì´ì½˜ íŒŒì¼ ì²´í¬:</strong> 
                    ${errorCount === 0 ? 'ëª¨ë“  íŒŒì¼ ì •ìƒ' : `${errorCount}ê°œ íŒŒì¼ ëˆ„ë½/ì˜¤ë¥˜`}
                </div>
                <details>
                    <summary>ìƒì„¸ ê²°ê³¼ ë³´ê¸°</summary>
                    <pre>${results.join('\n')}</pre>
                </details>
            `;
        }

        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'block';
            addLog('Install prompt captured and deferred');
            
            // í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë˜ì§€ ì•Šì€ ì´ìœ  í™•ì¸
            if (e.platforms) {
                addLog(`Supported platforms: ${e.platforms.join(', ')}`);
            }
        });

        // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                addLog('Showing install prompt...');
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                addLog(`User choice: ${outcome}`);
                
                if (outcome === 'accepted') {
                    addLog('User accepted the install prompt');
                } else {
                    addLog('User dismissed the install prompt');
                }
                
                deferredPrompt = null;
                document.getElementById('install-btn').style.display = 'none';
            }
        });

        // ìºì‹œ ì´ˆê¸°í™”
        document.getElementById('clear-cache-btn').addEventListener('click', async () => {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    
                    // Service Worker ë“±ë¡ í•´ì œ
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    
                    addLog('Cache and Service Workers cleared');
                    alert('ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload();
                } catch (error) {
                    addLog(`Cache clear error: ${error.message}`, 'error');
                    alert('ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
                }
            }
        });

        // ë¦¬ì†ŒìŠ¤ ì²´í¬ ë²„íŠ¼
        document.getElementById('check-resources-btn').addEventListener('click', checkResources);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì²´í¬
        window.addEventListener('load', async () => {
            addLog('Starting PWA diagnostics...');
            
            checkHTTPS();
            await checkServiceWorker();
            await checkManifest();
            checkInstallStatus();
            
            // ì„¤ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('appinstalled', () => {
                addLog('App was installed successfully!');
                checkInstallStatus();
            });
        });
    </script>
</body>
</html>